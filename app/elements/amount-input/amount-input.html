<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<dom-module id="amount-input">
  <template>
    <style>
      :host {
        display: block;
        margin: 16px;
      }

      .suggestions {
        position: absolute;
      }

      .input {
        position: relative;
        left: 0px;
        bottom: 0px;
        overflow: visible;
        z-index: 100000;
      }

      amount-chip {
        padding-right: 8px;
      }
    </style>


    <div class="layout horizontal center">
      <template is="dom-repeat" items="{{order}}">
        <amount-chip label="{{item.label}}" amount="{{item.amount}}" on-tap="_remove"></amount-chip>
      </template>


      <div class="input">
        <paper-input focused="{{focused}}" no-label-float value="{{input}}" on-keydown="_submit"></paper-input>
        <template is="dom-if" if="{{focused}}">
          <paper-material elevation="3" class="suggestions">
            <paper-menu selected="0">
              <template is="dom-repeat" items="{{_suggestions(types, input)}}">
                <paper-item>{{item}}</paper-item>
              </template>
            </paper-menu>
          </paper-material>
        </template>
      </div>
    </div>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'amount-input',

        properties: {
          types: {
            type: Array,
            value: [],
            notify: true
          },
          order: {
            type: Object,
            value: []
          }
        },

        _submit: function (e) {
          if (e.keyCode === 13) {
            var amount = this._amount(this.input);
            var types = this._types(this.input);

            if (isNaN(amount) || types.length == 0) {
              return;
            }

            var old = this.order
              .map(function(o) {return o.label;} )
              .indexOf(types[0]);

            if (old > -1) {
              this.splice('order', old, 1);
            }

            this.push('order', {label: types[0], amount: amount});
            this.input = '';
          }
          if (!this.input && e.keyCode === 8) {
            this.pop('order');
          }
        },

        _suggestions: function (types, input) {

          var amount = this._amount(input);
          if (isNaN(amount)) {
            return [];
          }
          return this._types(input).map(function (type) {
            return amount + ' ' + type
          });
        },

        _amount: function (input) {
          var amount = input.split(' ')[0];
          if (!amount) {
            return 1;
          }
          return parseInt(amount);
        },

        _types: function (input) {
          var type = input.split(' ')[1];
          if (!type) {
            return this.types;
          }

          return this.types
            .filter(function (t) {
              return t.toLowerCase().startsWith(type.toLowerCase())
            });
        },

        _remove: function (e) {
          this.splice('order', e.model.index, 1);
        }
      });
    })();
  </script>
</dom-module>
