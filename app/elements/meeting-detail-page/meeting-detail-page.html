<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="..\..\bower_components/paper-button/paper-button.html">
<link rel="import" href="..\..\bower_components/paper-item/paper-item.html">
<link rel="import" href="..\..\bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="..\..\bower_components/iron-icon/iron-icon.html">
<link rel="import" href="..\..\bower_components/iron-icons/social-icons.html">
<link rel="import" href="..\..\bower_components/iron-icons/maps-icons.html">
<link rel="import" href="..\..\bower_components/paper-fab/paper-fab.html">

<link rel="import" href="..\..\bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="..\..\bower_components/neon-animation/animations/hero-animation.html">
<link rel="import" href="..\..\bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="..\..\bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="..\..\bower_components/neon-animation/animations/scale-down-animation.html">
<link rel="import" href="..\..\bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="..\..\bower_components/neon-animation/animations/transform-animation.html">

<link rel="import" href="..\meeting-element/meeting-element.html">

<dom-module id="meeting-detail-page">
  <style include="shared-styles"></style>
  <style>

    #content {
      margin-top: 8px;
    }

    paper-fab {
      position: fixed;
      bottom: 32px;
      right: 32px;
    }

    .secondary {
      color: var(--secondary-text-color);
    }

    h2 {
      text-align: center;
    }
  </style>
  <template>

    <meeting-detail-data id="{{id}}" meeting="{{meeting}}"></meeting-detail-data>
    <div id="main">
      <div class="layout horizontal">
        <meeting-element class="flex" id="hero" meeting="{{meeting}}">
          <paper-icon-button on-tap="_navigateBack" icon="arrow-back"></paper-icon-button>
        </meeting-element>
      </div>

      <div id="content" class="layout vertical center" elevation="0">

        <div class="layout horizontal center">
          <statistic-badge amount="{{_ordersWeisswurst(meeting.orders)}}" title="Weisswurst"
                           color="#455A64"></statistic-badge>
          <statistic-badge amount="{{_ordersBrezen(meeting.orders)}}" title="Brezen" color="#455A64"></statistic-badge>
          <statistic-badge amount="{{_price(meeting.orders)}}" title="Preis" color="#009688"></statistic-badge>
        </div>

        <div class="layout horizontal wrap center-justified">

          <template is="dom-repeat" items="{{meeting.orders}}" as="order">
            <order-element meeting="{{meeting}}" user="{{user}}" order="{{order}}"></order-element>
          </template>

        </div>

        <h2 class="secondary" hidden="{{user}}">Um sich eintragen zu können, müssen Sie angemeldet sein.</h2>

      </div>
    </div>

    <!-- TODO Button muss beim laden so konfiguriert werden, dass ein nutzer sich nur eintragen kann, wenn er noch nicht im meeting ist. ansonsten soll der Button die Funktionalität erhalten, den Nutzer auszutragen. -->
    <paper-fab id="fab" icon="social:person-add" on-tap="_togglePerson" hidden="{{!user}}"></paper-fab>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'meeting-detail-page',

        behaviors: [Polymer.NeonSharedElementAnimatableBehavior],

        _setupFab: function () {
          var index = this._getIndexOfUser();
          var fab = this.$.fab;
          if (index === -1) {
            fab.icon = 'social:person-add';
          } else {
            fab.icon = 'social:person-outline';
          }
        },

        _togglePerson: function () {
          var index = this._getIndexOfUser();
          if (index === -1) {
            this.push('meeting.orders', {
              name: this.user.password.email,
              uid: this.user.uid,
              brezen: 0,
              weisswurst: 0,
              paid: false
            });
          } else {
            this.splice('meeting.orders', index, 1);
          }
        },

        _getIndexOfUser: function () {
          if (this.user) {
            if (!this.meeting.orders) {
              this.meeting.orders = [];
            }
            return this.meeting.orders.map(function (order) {
              return order.uid;
            }).indexOf(this.user.uid);
          }
        },

        _ordersWeisswurst: function (orders) {
          if (!orders) {
            return 0;
          }
          var counter = 0;
          orders.forEach(function (entry) {
            var num = parseInt(entry.weisswurst);
            if (!isNaN(num)) {
              counter += num;
            }
          });
          return counter;
        },

        _ordersBrezen: function (orders) {
          if (!orders) {
            return 0;
          }
          var counter = 0;
          orders.forEach(function (entry) {
            var num = parseInt(entry.brezen);
            if (!isNaN(num)) {
              counter += num;
            }
          });
          return counter;
        },

        _price: function (orders) {
          var ww = this._ordersWeisswurst(orders);
          var brez = this._ordersBrezen(orders);
          var priceWW = 1.00;
          var priceBrez = 0.60;
          var result = (ww * priceWW + brez * priceBrez);
          result = Math.ceil(result) + '€';
          return result;
        },

        _navigateBack: function () {
          page.show('/');
        },

        properties: {
          id: String,
          user: Object,
          meeting: {
            type: Object,
            observer: '_setupFab'
          },

          animationConfig: {
            type: Object,
            value: function () {
              return {
                'entry': [{
                  name: 'hero-animation',
                  id: 'hero',
                  toPage: this
                }, {
                  name: 'fade-in-animation',
                  node: this.$.content,
                  timing: {
                    delay: 200,
                    duration: 500
                  }
                },
                  {name: 'slide-down-animation', node: this.$.content, timing: {duration: 500}},
                  {name: 'scale-up-animation', node: this.$.fab}
                ],
                'exit': [{
                  name: 'transform-animation',
                  transformFrom: 'none',
                  transformTo: 'translate(0px,-100vh)',
                  node: this.$.main
                },
                  {name: 'scale-down-animation', node: this.$.fab}
                ]
              };
            }
          },

          sharedElements: {
            type: Object,
            value: function () {
              return {
                'hero': this.$.hero
              };
            }
          }
        }
      });
    })();
  </script>
</dom-module>
